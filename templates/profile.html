{% extends "base.html" %}
{% block title %}Profile{% endblock %}
{% block content %}

<style>
  :root{ --sand:#F6F3EC; --taupe:#B9A590; --espresso:#574C3F; --ink:#2b2b2b; }
  .card-soft{ background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:16px; }
  .section-title{ color:var(--espresso); font-weight:700; }
  .btn-espresso{ background:var(--espresso); color:#fff; border:1px solid #3f372d; border-radius:999px; padding:.5rem 1rem; font-weight:600; }
  .btn-espresso:hover{ background:#3f372d; color:#fff; }
  .form-control, .form-select{ border-radius:12px; }
  .badge-done{ background:var(--taupe); }
  .stat-chip{ background:#fff; border:1px solid var(--espresso); color:var(--espresso); padding:.35rem .6rem; border-radius:999px; font-weight:600; }
</style>

<div class="container py-4 py-md-5">
  <div class="row g-4">
    <!-- Left: Profile (now uses modals) -->
    <div class="col-12 col-lg-5">
      <div class="card-soft p-4">
        <h2 class="h5 section-title mb-3">Your Profile</h2>

        <div class="mb-3 small text-muted">
          <i class="bi bi-person-badge me-1"></i> UID: <strong>{{ user.uid }}</strong>
        </div>

        <div class="mb-1">
          <div class="fw-semibold">{{ user.name }}</div>
          <div class="text-muted small">{{ user.email }}</div>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button class="btn btn-espresso" data-bs-toggle="modal" data-bs-target="#editProfileModal">
            <i class="bi bi-pencil-square me-1"></i>Edit Profile
          </button>
          <button class="btn btn-outline-dark" style="border-radius:999px" data-bs-toggle="modal" data-bs-target="#changePwModal">
            <i class="bi bi-key me-1"></i>Change Password
          </button>
        </div>
      </div>
    </div>

    <!-- Right: Scores -->
    <div class="col-12 col-lg-7">
      <div class="card-soft p-4">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
          <h2 class="h5 section-title mb-0">Scores ({{ this_year }})</h2>
          <div class="d-flex gap-2">
            <span class="stat-chip">Completed: {{ completed_count }}</span>
            {% if avg_percent is not none %}<span class="stat-chip">Avg: {{ avg_percent }}%</span>{% endif %}
            {% if best_percent is not none %}<span class="stat-chip">Best: {{ best_percent }}%</span>{% endif %}
          </div>
        </div>

        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr class="text-muted">
                <th scope="col">Test</th>
                <th scope="col">Started</th>
                <th scope="col">Completed</th>
                <th scope="col" class="text-end">Score</th>
              </tr>
            </thead>
            <tbody>
              {% for a in attempts %}
              <tr>
                <td>
                  <div class="fw-semibold" style="color:var(--espresso)">
                    {{ tests[a.test_key].label if tests and a.test_key in tests else a.test_key }}
                  </div>
                  {% if a.completed_at %}
                    <span class="badge badge-done">Completed</span>
                  {% else %}
                    <span class="badge text-bg-secondary">In progress</span>
                  {% endif %}
                </td>
                <td><small class="text-muted">{{ a.started_at or '—' }}</small></td>
                <td><small class="text-muted">{{ a.completed_at or '—' }}</small></td>
                <td class="text-end">
                  {% if a.percent is not none %}
                    <strong>{{ '%.2f'|format(a.percent) }}%</strong>
                    {% if a.raw_score is not none and a.max_score is not none %}
                      <div class="small text-muted">{{ a.raw_score|int }} / {{ a.max_score|int }}</div>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>
              </tr>
              {% else %}
              <tr><td colspan="4" class="text-center text-muted py-4">No attempts recorded this year.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">
      <div class="modal-header">
        <h5 class="modal-title" id="editProfileLabel">Edit Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post">
        <input type="hidden" name="action" value="update_profile">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Name</label>
            <input class="form-control" name="name" value="{{ user.name }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input class="form-control" type="email" name="email" value="{{ user.email }}" required>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-espresso" type="submit">
            <i class="bi bi-save me-1"></i> Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePwModal" tabindex="-1" aria-labelledby="changePwLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">
      <div class="modal-header">
        <h5 class="modal-title" id="changePwLabel">Change Password</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post">
        <input type="hidden" name="action" value="change_password">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Current Password</label>
            <input class="form-control" type="password" name="current_password" required>
          </div>
          <div class="mb-3">
            <label class="form-label">New Password</label>
            <input class="form-control" type="password" name="new_password" required minlength="8">
          </div>
          <div class="mb-3">
            <label class="form-label">Confirm New Password</label>
            <input class="form-control" type="password" name="confirm_password" required>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-espresso" type="submit">
            <i class="bi bi-key me-1"></i> Update Password
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Optional: show a toast for flash messages -->
{% with msgs = get_flashed_messages(with_categories=true) %}
  {% if msgs %}
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
    {% for category, msg in msgs %}
    <div class="toast align-items-center text-bg-{{ 'success' if category=='success' else ('warning' if category=='warning' else ('danger' if category=='danger' else 'secondary')) }} border-0 mb-2" role="alert" data-bs-delay="4000" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">{{ msg }}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}
{% endwith %}

<script>
  document.addEventListener('shown.bs.modal', (e) => {
    const first = e.target.querySelector('input,select,textarea');
    if(first) first.focus();
  });
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.toast').forEach(t => new bootstrap.Toast(t).show());
  });
</script>

{% endblock %}
